{% extends "base.jade" %}

{% block extrahead %}
script(src="/static/js/vendor/jquery-ui-1.10.3/ui/jquery.ui.widget.js")
script(src="/static/js/vendor/jquery.iframe-transport.js")
script(src="/static/js/vendor/jQuery-File-Upload-9.5.2/js/jquery.fileupload.js")
script.
  $(function () {
    $("#uploadFile").fileupload({
      dataType: "xml",
      replaceFileInput: false,
      add: function (e, data) {
        $("#uploadButton").unbind("click").click(function () {
            $("#uploadKey").val('${filename}');
            data.submit();
            $("#uploadButton").text("Uploading...").attr("disabled", "disabled");
        });
      },
      done: function (e, data) {
        $("#message").html("Upload done!");
      },
      fail: function(e, data) {
        console.log(e);
        console.log(data);
      },
      always: function(e, data) {
        $("#uploadButton").text("Upload").removeAttr("disabled");
      },
      progress: function (e, data) {
        var progress = parseInt(data.loaded / data.total * 100, 10);
        if(progress == 100) {
          $("#progress").removeClass("progress-striped active");
        }
        else {
          $("#progress").addClass("progress-striped active");
        }
        $("#bar").css("width", progress + "%");
      }
    });
  });
{% endblock %}

{% block content %}
#content.container
  .row
      .col-xs-12.col-sm-6#upload-container
        .row
          .col-xs-12.col-sm-5.col-md-4
            h3.col-xs-center.col-sm-right up
          .col-xs-12.col-sm-7.col-md-8
            .col-xs-center.col-sm-left
              h4 drag and drop
              form(id="uploadForm", action="https://dropbucket-datastore.s3.amazonaws.com", method="post", enctype='multipart/form-data')
                input(type='hidden', name='key', id="uploadKey")
                input(type='hidden', name='AWSAccessKeyId', value='{{ AWSAccessKeyId }}')
                input(type='hidden', name='acl', value='public-read')
                input(type='hidden', name='success_action_redirect', value='/')
                input(type='hidden', name='policy', value='{{ policy }}')
                input(type='hidden', name='signature', value='{{ signature }}')
                input(type='hidden', name='Content-Type', value="")
                input(type='hidden', name='x-amz-meta-session_id', value='{{ session_id }}')
                input(type='file', name='file', id='uploadFile')
                button(type='button', id='uploadButton') Upload

            div#progress.progress
              div#bar.bar

            div.message

      .col-xs-12.col-sm-6#files-container
        .row
          .col-xs-12.col-sm-5.col-md-4
            h3.col-xs-center.col-sm-right down
          .col-xs-12.col-sm-7.col-md-8
            .col-xs-center.col-sm-left
              h4 pick and click
              .row#files
                each file in files
                  .file-wrapper.col-xs-12.col-md-6.col-lg-4
                    .file
                      a(href='/file/'+file.name)
                        button.btn=file.name
                      p.
                        Expires in <span id="{{loop.index}}_timeRemaining"></span>
                      script.
                          var endTime = 
                            new Date(Date.UTC(
                                {{ file.expire_time.year }}, 
                                {{ file.expire_time.month }} - 1, 
                                {{ file.expire_time.day }}, 
                                {{ file.expire_time.hour }},
                                {{ file.expire_time.minute }}, 
                                {{ file.expire_time.second }}));
                          startCountdown(endTime, {{loop.index}});
{% endblock %}

{% block scripts %}
script(type='text/javascript').
    $("document").ready(function() {
        $('#upload-button').prop('disabled', true);
        
        var size_limit = {{ size_limit }} / 1024 / 1024;

        $('#upload-button').click(function() {
            document.getElementById("upload-form").submit();
        });

        $("#file-input").change(function (e) {
            var files = e.currentTarget.files;
            var filesize = ((files[0].size/1024)/1024).toFixed(4); //MB
            if (filesize > size_limit) {
                alert("Selected file is larger than the " + 
                        size_limit + "MB limit.");
                $('#upload-button').prop('disabled', true);
            } else {
                $('#upload-button').prop('disabled', false);
            }
        });
    });
{% endblock %}
